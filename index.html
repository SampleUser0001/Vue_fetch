<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>郵便番号検索</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
</head>
<body>
    <div id="app">
        <section class="section">
            <div class="container">
                <h1 class="title has-text-centered">郵便番号検索</h1>
                
                <div class="columns is-centered">
                    <div class="column is-half">
                        <div class="field">
                            <label class="label">郵便番号</label>
                            <div class="control">
                                <input 
                                    class="input" 
                                    type="text" 
                                    placeholder="例: 7830060 または 783-0060"
                                    v-model="zipcode"
                                    @keyup.enter="searchAddress"
                                >
                            </div>
                        </div>
                        
                        <div class="field">
                            <div class="control">
                                <button 
                                    class="button is-primary is-fullwidth"
                                    @click="searchAddress"
                                    :class="{ 'is-loading': loading }"
                                    :disabled="!zipcode || loading"
                                >
                                    検索
                                </button>
                            </div>
                        </div>
                        
                        <div v-if="errorMessage" class="notification is-danger">
                            {{ errorMessage }}
                        </div>
                        
                        <div v-if="address" class="notification is-success">
                            <strong>住所:</strong> {{ address }}
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    zipcode: '',
                    address: '',
                    errorMessage: '',
                    loading: false
                }
            },
            methods: {
                async searchAddress() {
                    if (!this.zipcode) {
                        this.errorMessage = '郵便番号を入力してください。';
                        return;
                    }

                    this.loading = true;
                    this.errorMessage = '';
                    this.address = '';

                    const cleanZipcode = this.zipcode.replace('-', '');

                    // if (!/^\d{7}$/.test(cleanZipcode)) {
                    //     this.errorMessage = '郵便番号は7桁の数字で入力してください。';
                    //     return;
                    // }

                    fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${cleanZipcode}`
                    ).then(res => {
                        return res.json();
                    }).then(res => {
                        if (res.status === 200 && res.results && res.results.length > 0) {
                            const result = res.results[0];
                            this.address = result.address1 + result.address2 + result.address3;
                        } else if (res.message) {
                            this.errorMessage = res.message;
                        } else {
                            this.errorMessage = '該当する住所が見つかりませんでした。';
                        }
                    }).catch(err => {
                        this.errorMessage = 'APIの取得でエラーが発生しました。';
                    }).finally(() => {
                        this.loading = false;
                    });

                    }
                }
            }
        ).mount('#app');
    </script>
</body>
</html>